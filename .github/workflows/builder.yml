name: Build & Release (Windows, Linux, macOS, Raspberry Pi)

permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  push:
    branches:
      - main

jobs:
  prepare:
    name: Prepare version + release notes
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.vars.outputs.version }}
      build_tag: ${{ steps.vars.outputs.build_tag }}
      release_tag: ${{ steps.vars.outputs.release_tag }}
      release_name: ${{ steps.vars.outputs.release_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21

      - name: Compute VERSION and BUILD_TAG
        id: vars
        run: |
          VERSION=$(node -p 'require("./package.json").version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          BUILD_TAG="-v${{ github.run_number }}"
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          RELEASE_TAG="${VERSION}${BUILD_TAG}"
          RELEASE_NAME="HRMApp ${VERSION}${BUILD_TAG}"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_TAG=$BUILD_TAG" >> $GITHUB_ENV
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          echo "Extracted version: $VERSION"
          echo "Build Tag: $BUILD_TAG"
          echo "Release Tag: $RELEASE_TAG"

      - name: Generate Release Notes (Draft)
        id: release_notes
        uses: release-drafter/release-drafter@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          version: ${{ env.VERSION }}
          name: ${{ env.RELEASE_NAME }}
          tag: ${{ env.RELEASE_TAG }}
          prerelease: false
          header: "## Release Notes for HRMApp ${{ env.VERSION }}"

      - name: Save release notes to file
        run: |
          echo "${{ steps.release_notes.outputs.body }}" > release_notes.txt
      
      - name: Upload release notes artifact  (expire in 1 day)
        uses: actions/upload-artifact@v4
        with:
          name: release_notes-v${{ github.run_number }}
          path: release_notes.txt
          retention-days: 1
          
  build-windows:
    name: Build & Upload — Windows
    runs-on: windows-latest
    needs: prepare
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      BUILD_TAG: ${{ needs.prepare.outputs.build_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Electron App (Windows)
        run: npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List dist/
        run: Get-ChildItem -Recurse dist
        shell: pwsh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-dist
          path: |
            dist/**/*.msi
            dist/**/*.exe
            !dist/**/HRMApp.exe
            !dist/**/elevate.exe
          if-no-files-found: ignore
          retention-days: 7

  linux-x64:
    name: Build & Upload — Linux (x64)
    runs-on: ubuntu-latest
    needs: prepare
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      BUILD_TAG: ${{ needs.prepare.outputs.build_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 jq

      - name: Build Electron App (Linux x64)
        run: npm run build:linux:x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List dist/
        run: ls -R dist

      - name: Upload Linux x64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-dist
          path: |
            dist/**/*x86_64*.AppImage
            dist/**/*amd64*.deb
          if-no-files-found: ignore
          retention-days: 7

  raspi-armv7l:
    name: Build & Upload — Raspberry Pi (armv7)
    runs-on: ubuntu-latest
    needs: prepare
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      BUILD_TAG: ${{ needs.prepare.outputs.build_tag }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3

      # ⬇️ Use true armv7 container (not aarch64)
      - uses: uraimo/run-on-arch-action@v2
        with:
          arch: armv7
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y curl git ca-certificates libfuse2
            curl -fsSL https://deb.nodesource.com/setup_21.x | bash -
            apt-get install -y nodejs
          run: |
            npm ci
            npm run build:linux:armv7l
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List dist/
        run: ls -R dist

      - name: Upload Raspberry Pi (armv7) artifacts
        uses: actions/upload-artifact@v4
        with:
          name: raspi-armv7l-dist
          path: |
            dist/**/*armv7l*.AppImage
            dist/**/*armv7l*.deb
            dist/**/*_armhf.deb
          if-no-files-found: ignore
          retention-days: 7

  raspi-arm64:
    name: Build & Upload — Raspberry Pi (arm64)
    runs-on: ubuntu-latest
    needs: prepare
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      BUILD_TAG: ${{ needs.prepare.outputs.build_tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y curl git ca-certificates libfuse2
            curl -fsSL https://deb.nodesource.com/setup_21.x | bash -
            apt-get install -y nodejs
          run: |
            npm ci
            npm run build:linux:arm64

      - name: List dist/
        run: ls -R dist

      - name: Upload Raspberry Pi (arm64) artifacts
        uses: actions/upload-artifact@v4
        with:
          name: raspi-arm64-dist
          path: |
            dist/**/*arm64*.AppImage
            dist/**/*arm64*.deb
          if-no-files-found: ignore
          retention-days: 7
          
  build-macos:
    name: Build & Upload — macOS (Unsigned)
    runs-on: macos-latest
    needs: prepare

    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      BUILD_TAG: ${{ needs.prepare.outputs.build_tag }}
      CSC_IDENTITY_AUTO_DISCOVERY: false     # Prevent macOS signing
      CSC_FOR_PULL_REQUEST: true             # Prevent failures in PRs
      ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true
      ELECTRON_SKIP_NOTARIZATION: true       # Explicitly disable notarization

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 21
          cache: npm

      - name: Install Dependencies
        run: npm ci

      # ------------------------------------------------------
      # Build an UNSIGNED macOS .dmg and .zip
      # ------------------------------------------------------
      - name: Build Electron App (Unsigned macOS)
        run: |
          echo "Building unsigned macOS artifacts…"
          npm run build:mac -- --x64
          npm run build:mac -- --arm64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          CSC_LINK: ""                       # Remove certificate paths entirely
          CSC_KEY_PASSWORD: ""
          DEBUG: electron-builder

      - name: List dist/
        run: ls -R dist

      # ------------------------------------------------------
      # Upload unsigned dmg and zip artifacts
      # ------------------------------------------------------
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-dist-unsigned
          path: |
            dist/**/*.dmg
            dist/**/*.zip
          if-no-files-found: ignore
          retention-days: 7

  notify:
    name: Release + notify
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-windows
      - linux-x64
      - raspi-armv7l
      - raspi-arm64
      - build-macos
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      BUILD_TAG: ${{ needs.prepare.outputs.build_tag }}
      RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
      RELEASE_NAME: ${{ needs.prepare.outputs.release_name }}
    steps:
      - name: Download release notes artifact
        uses: actions/download-artifact@v4
        with:
          name: release_notes-v${{ github.run_number }}
          path: .

      - name: Show release notes
        run: |
          echo "----- RELEASE NOTES -----"
          cat release_notes.txt || true
          echo "-------------------------"

      - name: Download build artifacts (all platforms)
        uses: actions/download-artifact@v4
        if: always()
        with:
          pattern: "*dist*"
          path: artifacts
          merge-multiple: true

      - name: Compute download links
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          BASE="https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}"

          set_link() {
            local var="$1" pattern="$2"
            local file
            file=$(find artifacts -type f -name "$pattern" | head -n1 || true)
            if [ -n "$file" ] && [ -z "${!var:-}" ]; then
              echo "$var=$BASE/$(basename "$file")" >> "$GITHUB_ENV"
            fi
          }

          set_link WIN_EXE_URL "HRMApp-Setup-${{ env.VERSION }}.exe"
          set_link WIN_MSI_URL "HRMApp-Setup-${{ env.VERSION }}.msi"
          set_link LINUX_APPIMAGE_URL "*x86_64*.AppImage"
          set_link LINUX_DEB_URL "*amd64*.deb"
          set_link ARM7_APPIMG_URL "*armv7l*.AppImage"
          set_link ARM7_DEB_URL "*armv7l*.deb"
          set_link ARMHF_DEB_URL "*_armhf.deb"
          set_link ARM64_APPIMG_URL "*arm64*.AppImage"
          set_link ARM64_DEB_URL "*arm64*.deb"
          # Prefer x64 DMG/ZIP (Intel), then fall back to arm64
          set_link MAC_DMG_URL "*-x64.dmg"
          set_link MAC_DMG_URL "*-arm64.dmg"
          set_link MAC_ZIP_URL "*-x64.zip"
          set_link MAC_ZIP_URL "*-arm64.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release_notes.txt
          draft: false
          prerelease: false
          files: |
            artifacts/**
          fail_on_unmatched_files: false

      - name: Send Release Info to Discord
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          set -euo pipefail
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}"

          jq -n \
            --rawfile notes release_notes.txt \
            --arg content "<@&1384262560395559122> **UPDATE (ALL PLATFORMS)**" \
            --arg title "New Release: ${{ env.RELEASE_NAME }}" \
            --arg release_url "$RELEASE_URL" \
            --arg WIN_EXE_URL "${WIN_EXE_URL:-}" \
            --arg WIN_MSI_URL "${WIN_MSI_URL:-}" \
            --arg LINUX_APPIMAGE_URL "${LINUX_APPIMAGE_URL:-}" \
            --arg LINUX_DEB_URL "${LINUX_DEB_URL:-}" \
            --arg ARM7_APPIMG_URL "${ARM7_APPIMG_URL:-}" \
            --arg ARM7_DEB_URL "${ARM7_DEB_URL:-${ARMHF_DEB_URL:-}}" \
            --arg ARM64_APPIMG_URL "${ARM64_APPIMG_URL:-}" \
            --arg ARM64_DEB_URL "${ARM64_DEB_URL:-}" \
            --arg MAC_DMG_URL "${MAC_DMG_URL:-}" \
            --arg MAC_ZIP_URL "${MAC_ZIP_URL:-}" \
            --argjson color 65280 \
            --arg footer "Released by GitHub Actions" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          '
          def trunc(s; n): if (s|length) > n then (s[0:(n-1)] + "…") else s end;

          # Build the artifacts list with real newlines via join("\n")
          def artifacts_block:
            "**Available Artifacts:**\n" +
            ([
              ($WIN_EXE_URL | select(. != "") | "• [Windows (EXE)](" + . + ")"),
              ($WIN_MSI_URL | select(. != "") | "• [Windows (MSI)](" + . + ")"),
              ($LINUX_APPIMAGE_URL | select(. != "") | "• [Linux x64 AppImage](" + . + ")"),
              ($LINUX_DEB_URL | select(. != "") | "• [Linux x64 .deb](" + . + ")"),
              ($ARM7_APPIMG_URL | select(. != "") | "• [Raspberry Pi ARMv7 AppImage](" + . + ")"),
              ($ARM7_DEB_URL | select(. != "") | "• [Raspberry Pi ARMv7 .deb](" + . + ")"),
              ($ARM64_APPIMG_URL | select(. != "") | "• [Raspberry Pi ARM64 AppImage](" + . + ")"),
              ($ARM64_DEB_URL | select(. != "") | "• [Raspberry Pi ARM64 .deb](" + . + ")"),
              ($MAC_DMG_URL | select(. != "") | "• [macOS DMG (Intel preferred)](" + . + ")"),
              ($MAC_ZIP_URL | select(. != "") | "• [macOS ZIP (Intel preferred)](" + . + ")")
            ] | map(select(. != null)) | join("\n"));

          {
            username: "Pulsoid APP Bot",
            avatar_url: "https://cdn.discordapp.com/icons/1310653602951594024/cb8a2781368442a92b33dd2cb93b3afd.webp?size=512",
            content: $content,
            allowed_mentions: { parse: ["roles"] },
            embeds: [
              {
                title: $title,
                url: $release_url,
                description: trunc(($notes + "\n\n" + artifacts_block); 4096),
                color: $color,
                footer: { text: $footer },
                timestamp: $timestamp
              }
            ]
          }' > payload.json

          http_code=$(curl -sS -o response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$DISCORD_WEBHOOK")

          echo "Discord HTTP $http_code"
          if [[ "$http_code" != "204" && "$http_code" != "200" ]]; then
            echo "Error from Discord:"; cat response.txt; exit 1
          fi
